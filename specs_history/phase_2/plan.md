# Implementation Plan: Phase II Full-Stack Web Application

**Branch**: `002-fullstack-web-app` | **Date**: 2025-12-28 | **Spec**: [overview.md](./overview.md)
**Input**: Feature specifications from `/specs/002-fullstack-web-app/`

## Summary

Transform the Phase I console-based todo application into a full-stack, multi-user web application with secure authentication (Better Auth + JWT), persistent storage (Neon PostgreSQL), Next.js frontend, and FastAPI backend. This implementation establishes the foundation for Phase III AI integration.

## Technical Context

**Language/Version**: Python 3.11+ (backend), TypeScript 5+ (frontend)
**Primary Dependencies**: FastAPI, SQLModel, Next.js 16+, Better Auth
**Storage**: Neon Serverless PostgreSQL via `DATABASE_URL`
**Testing**: pytest (backend), Jest (frontend)
**Target Platform**: Web (modern browsers, mobile responsive)
**Project Type**: Web application (frontend + backend monorepo)
**Performance Goals**: <3s page load, <1s API response, 100 concurrent users
**Constraints**: JWT expiration 24h, rate limiting 5/min auth, 100/min tasks
**Scale/Scope**: 100K users, 1M tasks, 4 pages, 10 API endpoints

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| I. Spec-Driven Development | ✅ PASS | All features defined in specs/002-fullstack-web-app/ |
| II. End-to-End Traceability | ✅ PASS | Each component references its spec file |
| III. Security by Design | ✅ PASS | JWT auth, user isolation, password hashing documented |
| IV. Separation of Concerns | ✅ PASS | Clear frontend/backend/database separation |
| V. Scalability Ready | ✅ PASS | Monorepo structure, env config, extensible schema |

**Key Standards Compliance**:
- Authentication: Better Auth + JWT ✅ (@constitution, Key Standards)
- User Isolation: user_id scoping on all queries ✅ (@constitution, User Isolation)
- REST API: /api/ prefix, correct status codes ✅ (@constitution, REST API Conventions)
- Database: SQLModel ORM, DATABASE_URL ✅ (@constitution, Database)

## Project Structure

### Documentation (this feature)

```text
specs/002-fullstack-web-app/
├── overview.md              # Project scope and user stories
├── architecture.md          # System architecture
├── plan.md                  # This file
├── research.md              # Technology decisions
├── data-model.md            # Entity definitions
├── quickstart.md            # Setup instructions
├── features/
│   ├── authentication.md    # Auth feature spec
│   └── task-crud.md         # Task feature spec
├── api/
│   ├── rest-endpoints.md    # API endpoint spec
│   └── jwt-auth.md          # JWT flow spec
├── database/
│   └── schema.md            # Database schema spec
├── ui/
│   ├── pages.md             # Page specifications
│   └── components.md        # Component specifications
├── contracts/
│   └── api-contract.md      # Frontend-backend contract
├── checklists/
│   └── requirements.md      # Spec quality checklist
└── tasks.md                 # Implementation tasks (generated by /sp.tasks)
```

### Source Code (repository root)

```text
hackathon-todo/
├── .specify/                    # Spec-Kit Plus configuration
├── specs/                       # Feature specifications
├── CLAUDE.md                    # Root project instructions
├── frontend/
│   ├── CLAUDE.md               # Frontend-specific instructions
│   ├── src/
│   │   ├── app/                # Next.js App Router
│   │   │   ├── layout.tsx      # Root layout
│   │   │   ├── page.tsx        # Home/landing page
│   │   │   ├── login/
│   │   │   │   └── page.tsx    # Login page
│   │   │   ├── signup/
│   │   │   │   └── page.tsx    # Signup page
│   │   │   └── dashboard/
│   │   │       └── page.tsx    # Dashboard page
│   │   ├── components/
│   │   │   ├── ui/             # Base UI components
│   │   │   │   ├── Button.tsx
│   │   │   │   ├── Input.tsx
│   │   │   │   ├── Card.tsx
│   │   │   │   ├── Alert.tsx
│   │   │   │   └── LoadingSpinner.tsx
│   │   │   ├── layout/
│   │   │   │   ├── Header.tsx
│   │   │   │   └── Footer.tsx
│   │   │   ├── auth/
│   │   │   │   ├── LoginForm.tsx
│   │   │   │   └── SignupForm.tsx
│   │   │   └── tasks/
│   │   │       ├── TaskList.tsx
│   │   │       ├── TaskItem.tsx
│   │   │       ├── TaskForm.tsx
│   │   │       └── EmptyState.tsx
│   │   ├── lib/
│   │   │   ├── api.ts          # API client
│   │   │   ├── auth.ts         # Auth utilities
│   │   │   └── types.ts        # TypeScript types
│   │   └── middleware.ts       # Route protection
│   ├── public/
│   ├── package.json
│   ├── tailwind.config.js
│   └── tsconfig.json
├── backend/
│   ├── CLAUDE.md               # Backend-specific instructions
│   ├── src/
│   │   ├── __init__.py
│   │   ├── main.py             # FastAPI app entry
│   │   ├── core/
│   │   │   ├── __init__.py
│   │   │   ├── config.py       # Environment config
│   │   │   ├── database.py     # Database connection
│   │   │   ├── security.py     # Password hashing, JWT
│   │   │   └── dependencies.py # DI (current_user, db)
│   │   ├── models/
│   │   │   ├── __init__.py
│   │   │   ├── user.py         # User SQLModel
│   │   │   └── task.py         # Task SQLModel
│   │   ├── schemas/
│   │   │   ├── __init__.py
│   │   │   ├── auth.py         # Auth request/response
│   │   │   ├── task.py         # Task request/response
│   │   │   └── error.py        # Error response
│   │   ├── api/
│   │   │   ├── __init__.py
│   │   │   ├── router.py       # Main router
│   │   │   ├── auth.py         # Auth endpoints
│   │   │   └── tasks.py        # Task endpoints
│   │   ├── services/
│   │   │   ├── __init__.py
│   │   │   ├── auth.py         # Auth business logic
│   │   │   └── task.py         # Task business logic
│   │   └── db/
│   │       ├── __init__.py
│   │       └── migrate.py      # Migration runner
│   ├── tests/
│   │   ├── __init__.py
│   │   ├── conftest.py         # Test fixtures
│   │   ├── test_auth.py        # Auth endpoint tests
│   │   └── test_tasks.py       # Task endpoint tests
│   ├── pyproject.toml
│   └── requirements.txt
├── docker-compose.yml
└── README.md
```

**Structure Decision**: Web application structure with separate frontend (Next.js) and backend (FastAPI) packages, following constitution's mandatory monorepo layout.

---

## 1. Monorepo Folder Layout

### Root Level

| Path | Purpose | Reference |
|------|---------|-----------|
| `CLAUDE.md` | Root project instructions | @constitution SC-005 |
| `docker-compose.yml` | Local development orchestration | @constitution, Mandatory Structure |
| `README.md` | Project documentation | @constitution, Mandatory Structure |
| `.specify/` | Spec-Kit Plus configuration | @constitution, Mandatory Structure |
| `specs/` | Feature specifications | @constitution, Mandatory Structure |

### Frontend Package

| Path | Purpose | Reference |
|------|---------|-----------|
| `frontend/CLAUDE.md` | Frontend-specific AI instructions | @constitution SC-005 |
| `frontend/src/app/` | Next.js App Router pages | @specs/ui/pages.md |
| `frontend/src/components/` | React UI components | @specs/ui/components.md |
| `frontend/src/lib/` | Utilities and API client | @specs/architecture.md |

### Backend Package

| Path | Purpose | Reference |
|------|---------|-----------|
| `backend/CLAUDE.md` | Backend-specific AI instructions | @constitution SC-005 |
| `backend/src/api/` | FastAPI route handlers | @specs/api/rest-endpoints.md |
| `backend/src/models/` | SQLModel entities | @specs/database/schema.md |
| `backend/src/services/` | Business logic layer | @specs/architecture.md |
| `backend/src/core/` | Configuration and dependencies | @specs/api/jwt-auth.md |

---

## 2. Database Layer Design

### SQLModel Models

**User Model** (@specs/database/schema.md):
- Table: `users`
- Fields: id (UUID PK), email (unique), password_hash, created_at
- Index: Unique on email

**Task Model** (@specs/database/schema.md):
- Table: `tasks`
- Fields: id (UUID PK), user_id (FK), title, description, completed, created_at, updated_at
- Index: Composite on (user_id, created_at DESC)
- Foreign Key: user_id → users.id ON DELETE CASCADE

### Migration Strategy

1. Enable `uuid-ossp` extension
2. Create `users` table with unique email constraint
3. Create `tasks` table with foreign key to users
4. Create indexes for query optimization

**Reference**: See [data-model.md](./data-model.md) for complete entity definitions.

---

## 3. Authentication Flow Architecture

### Registration Flow (@specs/features/authentication.md)

```
Frontend                    Backend                     Database
   │                           │                            │
   │  POST /api/auth/signup    │                            │
   │  {email, password}        │                            │
   │ ────────────────────────► │                            │
   │                           │  Check email uniqueness    │
   │                           │ ──────────────────────────►│
   │                           │                            │
   │                           │  Hash password (bcrypt)    │
   │                           │                            │
   │                           │  Insert user               │
   │                           │ ──────────────────────────►│
   │                           │                            │
   │                           │  Generate JWT              │
   │                           │  (sub, email, iat, exp)    │
   │                           │                            │
   │  {user, token}            │                            │
   │ ◄──────────────────────── │                            │
   │                           │                            │
   │  Store token (localStorage)                            │
   │  Redirect to /dashboard   │                            │
```

### Login Flow (@specs/features/authentication.md)

```
Frontend                    Backend                     Database
   │                           │                            │
   │  POST /api/auth/signin    │                            │
   │  {email, password}        │                            │
   │ ────────────────────────► │                            │
   │                           │  Lookup user by email      │
   │                           │ ──────────────────────────►│
   │                           │                            │
   │                           │  Verify password (bcrypt)  │
   │                           │                            │
   │                           │  Generate JWT              │
   │                           │                            │
   │  {user, token}            │                            │
   │ ◄──────────────────────── │                            │
   │                           │                            │
   │  Store token              │                            │
   │  Redirect to /dashboard   │                            │
```

### JWT Token Structure (@specs/api/jwt-auth.md)

| Claim | Type | Description |
|-------|------|-------------|
| sub | UUID | User ID |
| email | string | User email |
| iat | timestamp | Issued at |
| exp | timestamp | Expiration (24h) |

**Signing**: HS256 with `BETTER_AUTH_SECRET`

---

## 4. REST API Design

### Endpoints (@specs/api/rest-endpoints.md)

| Method | Path | Auth | Purpose |
|--------|------|------|---------|
| POST | /api/auth/signup | No | Register user |
| POST | /api/auth/signin | No | Authenticate user |
| POST | /api/auth/signout | Yes | End session |
| GET | /api/tasks | Yes | List user's tasks |
| POST | /api/tasks | Yes | Create task |
| GET | /api/tasks/{id} | Yes | Get task |
| PUT | /api/tasks/{id} | Yes | Update task |
| DELETE | /api/tasks/{id} | Yes | Delete task |
| PATCH | /api/tasks/{id}/toggle | Yes | Toggle completion |

### Response Format

**Success**: Resource data with appropriate status code (200, 201)
**Error**: `{error: {code, message, details[]}}` with status code (401, 404, 409, 422)

**Reference**: See [contracts/api-contract.md](./contracts/api-contract.md) for complete request/response specifications.

---

## 5. JWT Verification Middleware Design

### Middleware Flow

```
Request → Extract Bearer token → Verify signature → Check expiration → Extract user_id → Inject current_user → Route handler
```

### Implementation Components

1. **Token Extraction**: Parse `Authorization: Bearer <token>` header
2. **Signature Verification**: Decode with `BETTER_AUTH_SECRET`
3. **Expiration Check**: Compare `exp` claim with current time
4. **User Context**: Extract `sub` claim as `user_id`
5. **Dependency Injection**: Provide `current_user` to route handlers

### Error Handling (@specs/api/jwt-auth.md)

| Scenario | HTTP Status | Error Code |
|----------|-------------|------------|
| Missing token | 401 | UNAUTHORIZED |
| Invalid signature | 401 | UNAUTHORIZED |
| Expired token | 401 | UNAUTHORIZED |
| Malformed header | 401 | UNAUTHORIZED |

---

## 6. Frontend Data-Flow Architecture

### State Management

| State | Scope | Storage |
|-------|-------|---------|
| Auth token | Global | localStorage |
| Current user | Global | React context |
| Task list | Dashboard | Component state |
| Form state | Component | Local state |

### API Client Architecture

```
Components → API Client → Fetch with JWT → Backend → Response → Update State
```

**API Client Responsibilities**:
1. Retrieve token from localStorage
2. Attach `Authorization: Bearer <token>` header
3. Handle response JSON parsing
4. Redirect to login on 401 responses

### Data Flow Patterns

**Page Load**:
```
Route protection (middleware) → Check token → API fetch tasks → Render list
```

**Task Creation**:
```
Form submit → API POST → Success → Add to local state → Close form
```

**Task Update**:
```
Edit click → Open form → API PUT → Success → Update local state → Close form
```

---

## 7. UI Page/Component Hierarchy

### Page Hierarchy (@specs/ui/pages.md)

```
app/
├── layout.tsx                 # Root layout (Header, Footer)
├── page.tsx                   # Home (/) - landing page
├── login/
│   └── page.tsx              # Login (/login)
├── signup/
│   └── page.tsx              # Signup (/signup)
└── dashboard/
    └── page.tsx              # Dashboard (/dashboard) - protected
```

### Component Hierarchy (@specs/ui/components.md)

```
Layout Components
├── Header (branding, auth links/user menu)
├── Footer (minimal footer)
└── Card (content container)

Form Components
├── Input (text, email, password)
└── Button (primary, secondary, danger, loading)

Auth Components
├── LoginForm (email, password, submit)
└── SignupForm (email, password, requirements, submit)

Task Components
├── TaskList (maps to TaskItem)
├── TaskItem (checkbox, title, description, edit, delete)
├── TaskForm (create/edit modal)
└── EmptyState (no tasks message + CTA)

Feedback Components
├── Alert (success, error, info, warning)
└── LoadingSpinner (small, medium, large)
```

---

## 8. Error Handling and Security Strategy

### Backend Error Handling

| Layer | Strategy |
|-------|----------|
| Validation | Pydantic model validation → 422 with field details |
| Authentication | JWT middleware → 401 with generic message |
| Authorization | Service layer ownership check → 404 (hide existence) |
| Database | Exception handler → 500 with safe message |

### Frontend Error Handling

| Scenario | Action |
|----------|--------|
| 401 response | Clear token, redirect to login |
| 404 response | Display "not found" alert |
| 422 response | Show field-level validation errors |
| Network error | Display retry alert |

### Security Measures

| Measure | Implementation | Reference |
|---------|----------------|-----------|
| Password hashing | bcrypt | @specs/features/authentication.md |
| JWT signing | HS256 with secret | @specs/api/jwt-auth.md |
| User isolation | Query filtering by user_id | @constitution, User Isolation |
| Generic auth errors | Same message for wrong email/password | @specs/features/authentication.md |
| Rate limiting | 5/min auth, 100/min tasks | @specs/api/rest-endpoints.md |
| HTTPS | Required in production | @specs/api/jwt-auth.md FR-JWT-006 |

---

## 9. Environment Variable & Secrets Management

### Environment Variables

| Variable | Layer | Purpose | Required |
|----------|-------|---------|----------|
| `DATABASE_URL` | Backend | PostgreSQL connection string | Yes |
| `BETTER_AUTH_SECRET` | Both | JWT signing key (32+ chars) | Yes |
| `NEXT_PUBLIC_API_URL` | Frontend | Backend API base URL | Yes |

### Configuration Guidelines

1. **Never commit secrets**: Add `.env` to `.gitignore`
2. **Use .env.example**: Document required variables without values
3. **Validate at startup**: Check required variables exist
4. **Match secrets**: `BETTER_AUTH_SECRET` identical in frontend/backend

### File Locations

- Backend: `backend/.env`
- Frontend: `frontend/.env.local`
- Example: `backend/.env.example`, `frontend/.env.example`

---

## 10. Step-by-Step Implementation Order

### Phase 1: Project Setup
1. Create monorepo folder structure
2. Initialize frontend (Next.js + TypeScript + Tailwind)
3. Initialize backend (FastAPI + SQLModel)
4. Create CLAUDE.md files (root, frontend, backend)
5. Configure environment variables

### Phase 2: Database Layer
1. Configure database connection
2. Create User model
3. Create Task model with foreign key
4. Create migration script
5. Run initial migration

### Phase 3: Backend Authentication
1. Create auth schemas (request/response)
2. Implement password hashing utilities
3. Implement JWT utilities (create/verify)
4. Create auth service (signup, signin)
5. Create auth router endpoints
6. Add JWT middleware for protected routes

### Phase 4: Backend Task API
1. Create task schemas
2. Create task service (CRUD + toggle)
3. Create task router with protection
4. Implement user isolation in queries
5. Add error handling

### Phase 5: Frontend Foundation
1. Create base UI components (Button, Input, Card)
2. Create layout components (Header, Footer)
3. Create feedback components (Alert, LoadingSpinner)
4. Set up API client with token handling

### Phase 6: Frontend Authentication
1. Create auth context and provider
2. Create LoginForm component
3. Create SignupForm component
4. Create login/signup pages
5. Implement route protection middleware

### Phase 7: Frontend Task Management
1. Create TaskItem component
2. Create TaskList component
3. Create TaskForm component
4. Create EmptyState component
5. Create dashboard page
6. Integrate API calls

### Phase 8: Integration & Testing
1. End-to-end flow testing
2. User isolation verification
3. Error handling verification
4. Responsive design testing
5. Performance validation

---

## 11. Testing & Validation Strategy

### Backend Testing

| Test Type | Focus | Tools |
|-----------|-------|-------|
| Unit | Service logic | pytest |
| Integration | API endpoints | pytest + TestClient |
| Contract | Response format | pytest + schema validation |

**Key Test Cases**:
- Registration with valid/invalid data
- Login with correct/incorrect credentials
- CRUD operations with owned tasks
- Rejection of operations on other users' tasks
- 401 on missing/invalid tokens

### Frontend Testing

| Test Type | Focus | Tools |
|-----------|-------|-------|
| Unit | Components | Jest + React Testing Library |
| Integration | User flows | Playwright |

**Key Test Cases**:
- Form validation feedback
- Auth flow (signup → dashboard)
- Task CRUD operations
- Error state handling

### Acceptance Criteria Validation

| Criterion | Test Method |
|-----------|-------------|
| Registration < 2 min | Manual timing |
| Login < 5 sec | Performance test |
| Task creation < 3 clicks | Manual count |
| User isolation | Multi-user test |
| 401 on unauthorized | API test |
| Mobile usable | Responsive test |
| Data persists | Refresh test |

---

## 12. Readiness Checklist Before sp.tasks

- [x] Technical Context complete (no NEEDS CLARIFICATION)
- [x] Constitution Check passed (all 5 principles)
- [x] research.md generated with all decisions
- [x] data-model.md generated with entities
- [x] contracts/api-contract.md generated
- [x] quickstart.md generated with setup steps
- [x] Project structure defined (frontend/backend)
- [x] All 10 API endpoints specified
- [x] JWT flow documented
- [x] Error handling strategy defined
- [x] Environment variables documented
- [x] Implementation order defined (8 phases)
- [x] Testing strategy defined

---

## Complexity Tracking

No violations to justify - all design decisions align with Constitution principles.

---

## Next Steps

Run `/sp.tasks` to generate atomic implementation tasks from this plan.
